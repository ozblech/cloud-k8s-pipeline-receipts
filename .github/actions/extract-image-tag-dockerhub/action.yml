name: Extract Image Tag from Docker Hub
description: "Fetches the latest Docker image tag (short SHA) from Docker Hub"

inputs:
  image-repo:
    description: "Docker image repository (e.g., ozblech/receipts-api)"
    required: true

outputs:
  current_image_sha:
    description: "Current image tag (e.g., a1b2c3d)"
    value: ${{ steps.fetch-latest-tag.outputs.current_image_sha }}

runs:
  using: "composite"
  steps:
    - name: Fetch latest Docker tag (short SHA) from Docker Hub
      id: fetch-latest-tag
      shell: bash
      run: |
        set -euo pipefail

        IMAGE_REPO="${{ inputs.image-repo }}"
        echo "Fetching tags for $IMAGE_REPO from Docker Hub..."

        RAW_JSON=$(curl -s "https://registry.hub.docker.com/v2/repositories/${IMAGE_REPO}/tags?page_size=100")

        # Extract short SHA tags with their last pushed time
        TAG=$(echo "$RAW_JSON" \
          | jq -r '.results[] | select(.name | test("^[a-f0-9]{7}$")) | "\(.tag_last_pushed) \(.name)"' \
          | sort -r \
          | head -n1 \
          | awk '{print $2}')

        if [[ -z "$TAG" ]]; then
          echo "âŒ No tags found."
          exit 1
        fi

        # Extract the last 7 characters (assumed to be the short SHA)
        SHORT_SHA="${TAG: -7}"

        echo "âœ… Latest tag is: $TAG"
        echo "ðŸ§© Extracted short SHA: $SHORT_SHA"
        echo "current_image_sha=$SHORT_SHA" >> "$GITHUB_OUTPUT"