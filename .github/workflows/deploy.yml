name: CD - Deploy with kubectl

permissions:
  id-token: write  # Required for OIDC
  contents: read   # Required for actions/checkout

on:
  workflow_call:
    inputs:
      image_tag:
        required: true
        type: string

env:
  IMAGE_REPO: ${{ vars.IMAGE_REPO }}                # e.g., ozblech/receipts-api
  DEPLOYMENT_NAME: ${{ vars.DEPLOYMENT_NAME }}      # e.g., receipts-api
  AWS_REGION: ${{ secrets.AWS_REGION }}             # e.g., us-east-1  
  IMAGE_TAG: ${{ inputs.image_tag }}                # e.g., a1b2c3d
  SECRET_NAME: "receipts-app-secrets_neww12"     # Name of the secret in AWS Secrets Manager
  KUBECONFIG_PATH: ${{ vars.KUBECONFIG_PATH }}      # Path to the kubeconfig file on the EC2 instance
  S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}     # Name of the S3 bucket to store Helm chart tarball
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}     # AWS Account ID

jobs:
  deploy:
    name: Deploy to EC2 Minikube
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code # for using actions
        uses: actions/checkout@v4

      - name: Fetch EC2 public IP
        id: fetch-minikube-ec2-ip
        uses: ./.github/actions/fetch-ec2-public-ip
        with:
          tag_name: ${{ vars.MINIKUBE_EC2_TAG_NAME }}       # e.g., minikube-ec2
          aws_account_id: ${{ env.AWS_ACCOUNT_ID }}
          aws_region: ${{ env.AWS_REGION }}

      - name: Print DNS
        run: echo "DNS is ${{ steps.fetch-minikube-ec2-ip.outputs.public_dns }}"

      - name: Tar and base64-encode Helm chart
        run: |
          tar -czf helm_chart.tar.gz -C receipts_project/helm_chart .
          echo "Helm chart tar file created and encoded."
          ls -l helm_chart*

      - name: Update copy-helm-and-script-and-deploy.json and deploy.sh script with current image tag and other variables
        run: |
          envsubst '$S3_BUCKET_NAME,$AWS_REGION' < .github/ssm-commands/copy-helm-and-script-and-deploy.json > copy-helm-and-script-and-deploy.json
          envsubst '$IMAGE_TAG,$DEPLOYMENT_NAME,$IMAGE_REPO,$KUBECONFIG_PATH,$SECRET_NAME,$S3_BUCKET_NAME,$AWS_REGION' < .github/ssm-scripts/deploy.sh > deploy.sh
          cat deploy.sh

      - name: Upload Helm chart tarball and deploy.sh to S3
        run: |
          aws s3 cp helm_chart.tar.gz s3://${{ env.S3_BUCKET_NAME }}/helm_chart.tar.gz
          aws s3 cp deploy.sh s3://${{ env.S3_BUCKET_NAME }}/deploy.sh

      - name: Run SSM command to copy Helm chart tar file and deploy script from S3 to EC2 and run helm upgrade
        id: run-ssm-copy-helm-chart-and-deploy
        uses: ./.github/actions/ssm
        with:
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          instance_id: ${{ steps.fetch-minikube-ec2-ip.outputs.instance_id }}
          commands-file-name: copy-helm-and-script-and-deploy.json
          aws_region: ${{ env.AWS_REGION }}

      # - name: Configure AWS Credentials
      #   uses: aws-actions/configure-aws-credentials@v3
      #   with:
      #     role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role
      #     aws-region: ${{ secrets.AWS_REGION }}

      # - name: Deploy via SSM to EC2
      #   env:
      #     INSTANCE_ID: ${{ steps.fetch-minikube-ec2-ip.outputs.instance_id }}
      #     IMAGE_TAG: ${{ steps.extract-image-tag.outputs.current_image_tag }}
      #   run: |
      #     aws ssm send-command \
      #       --instance-ids $INSTANCE_ID \
      #       --document-name "AWS-RunShellScript" \
      #       --comment "Update Kubernetes deployment image" \
      #       --parameters commands=["export KUBECONFIG=/home/ec2-user/.kube/config","kubectl set image deployment/receipts-api receipts-api=ozblech/receipts-api:$IMAGE_TAG"] \
      #       --cloud-watch-output-config CloudWatchOutputEnabled=true \
      #       --output text