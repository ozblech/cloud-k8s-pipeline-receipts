name: CD - Rollback Deployment

permissions:
  id-token: write # Required for OIDC
  contents: read

on:
  workflow_dispatch:
    inputs:
      revision:
        description: 'Revision number to roll back to (leave empty for previous)'
        required: false
        default: ''

jobs:
  rollback:
    runs-on: ubuntu-latest
    env:
      IMAGE_REPO: ozblech/receipts-api
      DEPLOYMENT_NAME: receipts-api

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2_key.pem
          chmod 600 ec2_key.pem

      - name: Fetch EC2 public IP
        id: fetch-minikube-ec2-ip
        uses: ./.github/actions/fetch-ec2-public-ip
        with:
          tag_name: minikube-ec2
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}

      - name: Get latest Git tag
        if: ${{ github.event.inputs.revision == '' }}
        id: get-latest-tag
        uses: ./.github/actions/extract-image-tag

      - name: Echo previous image tag
        if: ${{ github.event.inputs.revision == '' }}
        run: |
            echo "Previous image tag: ${{ steps.get-latest-tag.outputs.previous_image_tag }}"   

      # - name: Rollback via SSH
      #   env:
      #       REVISION_INPUT: ${{ github.event.inputs.revision }}
      #       PREVIOUS_IMAGE_TAG: ${{ steps.get-latest-tag.outputs.previous_image_tag }}
      #       EC2_PUBLIC_DNS: ${{ steps.fetch-minikube-ec2-ip.outputs.public_dns }}
      #   run: |
      #       ssh -o StrictHostKeyChecking=no -i ec2_key.pem ec2-user@$EC2_PUBLIC_DNS << EOF
      #       export KUBECONFIG=\$HOME/.kube/config

      #       if [ -z "$REVISION_INPUT" ]; then
      #           echo "Rolling back to previous image tag: $PREVIOUS_IMAGE_TAG"
      #           kubectl set image deployment/$DEPLOYMENT_NAME receipts-api=$IMAGE_REPO:$PREVIOUS_IMAGE_TAG -n default
      #       else
      #           echo "Rolling back to revision: $REVISION_INPUT"
      #           kubectl rollout undo deployment/$DEPLOYMENT_NAME --to-revision=$REVISION_INPUT -n default
      #       fi

      #       kubectl rollout status deployment/$DEPLOYMENT_NAME -n default
      #       EOF

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: us-west-2

      - name: Rollback via SSM to EC2
        env:
          INSTANCE_ID: ${{ steps.fetch-minikube-ec2-ip.outputs.instance_id }}
          REVISION_INPUT: ${{ github.event.inputs.revision }}
          PREVIOUS_IMAGE_TAG: ${{ steps.get-latest-tag.outputs.previous_image_tag }}
          EC2_PUBLIC_DNS: ${{ steps.fetch-minikube-ec2-ip.outputs.public_dns }}
        run: |
          aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --comment "Rollback deployment" \
            --parameters 'commands=["#!/bin/bash",
              "export KUBECONFIG=/home/ec2-user/.kube/config",
              "if [ -z \"${REVISION_INPUT}\" ]; then",
              "  echo Rolling back to previous image tag: ${PREVIOUS_IMAGE_TAG}",
              "  kubectl set image deployment/${DEPLOYMENT_NAME} receipts-api=${IMAGE_REPO}:${PREVIOUS_IMAGE_TAG} -n default",
              "else",
              "  echo Rolling back to revision: ${REVISION_INPUT}",
              "  kubectl rollout undo deployment/${DEPLOYMENT_NAME} --to-revision=${REVISION_INPUT} -n default",
              "fi",
              "kubectl rollout status deployment/${DEPLOYMENT_NAME} -n default"
            ]' \
            --cloud-watch-output-config CloudWatchOutputEnabled=true \
            --region us-west-2 \
            --output text


