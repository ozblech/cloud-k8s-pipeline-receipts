name: CD - Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      revision:
        description: 'Revision number to roll back to (leave empty for previous)'
        required: false
        default: ''

jobs:
  get-latest-tag:
    runs-on: ubuntu-latest
    if: ${{ !github.event.inputs.revision }}
    outputs:
      previous_image_tag: ${{ steps.extract-image-tag.outputs.previous_image_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest Git tag
        id: extract-image-tag
        uses: ./.github/actions/extract-image-tag

  rollback:
    needs: get-latest-tag  # <-- Required to access outputs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2_key.pem
          chmod 600 ec2_key.pem
        
      - name: Fetch minikube IP
        id: fetch-minikube-ec2-ip
        uses: ./.github/actions/fetch-ec2-public-ip
        with:
          tag_name: minikube-ec2
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
        
      - name: Print DNS
        run: echo "DNS is ${{ steps.fetch-minikube-ec2-ip.outputs.public_dns }}"

      - name: Rollback via SSH
        run: |
            export IMAGE_REPO="ozblech/receipts-api"
            export DEPLOYMENT_NAME="receipts-api"
            ssh -o StrictHostKeyChecking=no -i ec2_key.pem ec2-user@${{ steps.fetch-minikube-ec2-ip.outputs.public_dns }} << EOF
                export KUBECONFIG=\$HOME/.kube/config

                if [ -z "${{ github.event.inputs.revision }}" ]; then
                    echo "Rolling back to previous image tag: ${{ needs.get-latest-tag.outputs.previous_image_tag }}"
                    kubectl set image deployment/receipts-api receipts=ozblech/receipts-api:${{ needs.get-latest-tag.outputs.previous_image_tag }} -n default
                else
                    echo "Rolling back to revision: ${{ github.event.inputs.revision }}"
                    kubectl rollout undo deployment/receipts-api --to-revision=${{ github.event.inputs.revision }} -n default
                fi

                kubectl rollout status deployment/receipts-api -n default
            EOF